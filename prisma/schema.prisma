// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "./generated"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       Int    @id @default(autoincrement())
  email    String @unique
  username String @unique
  password String // Hash hasła (bcrypt przez nuxt-auth-utils)

  // Profil użytkownika (do OAuth i dashboardu)
  name      String?
  avatarUrl String?
  bio       String? // krótki opis użytkownika
  role      String  @default("user") // tekstowa nazwa roli (dla zgodności wstecznej)

  // Główna rola powiązana przez tabelę Role (MVP: jedna rola per user)
  roleId  Int?
  roleRef Role? @relation("UserRole", fields: [roleId], references: [id])

  emailVerifiedAt   DateTime?
  passwordChangedAt DateTime?
  deactivatedAt     DateTime? // tymczasowa dezaktywacja; logowanie reaktywuje konto
  showEmail         Boolean   @default(true) // czy pokazywać email w profilu publicznym

  emailVerificationTokens   EmailVerificationToken[]
  passwordResetTokens       PasswordResetToken[]
  oauthAccounts             OAuthAccount[]
  notifications             Notification[]
  mediaAssets               MediaAsset[]
  userSessions              UserSession[]
  loginEvents               LoginEvent[]
  activityLogs              ActivityLog[]
  userSettings              UserSettings?
  blogPosts                 BlogPost[]
  chatThreadsCreated        ChatThread[]             @relation("ChatThreadCreated")
  chatMessages              ChatMessage[]
  chatParticipants          ChatParticipant[]
  chatThreadInvitesSent     ChatThreadInvite[]       @relation("ChatThreadInviteSent")
  chatThreadInvitesReceived ChatThreadInvite[]       @relation("ChatThreadInviteReceived")
  friendRequestsSent        FriendRequest[]          @relation("FriendRequestSent")
  friendRequestsReceived    FriendRequest[]          @relation("FriendRequestReceived")
  teamsOwned                Team[]                   @relation("TeamOwner")
  teamMembers               TeamMember[]
  teamInvitesSent           TeamInvite[]             @relation("TeamInviteSent")
  teamInvitesReceived       TeamInvite[]             @relation("TeamInviteReceived")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ChatThreadType {
  ai
  dm
  room
  team
}

enum ChatMessageType {
  user
  assistant
  system
}

enum ChatInviteStatus {
  pending
  accepted
  rejected
}

enum FriendRequestStatus {
  pending
  accepted
  declined
  canceled
  blocked
}

enum TeamRole {
  owner
  admin
  member
}

enum TeamInviteStatus {
  pending
  accepted
  declined
  canceled
}

model ChatThread {
  id            Int            @id @default(autoincrement())
  type          ChatThreadType
  title         String?
  createdById   Int?
  teamId        Int?
  dmKey         String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  lastMessageAt DateTime?

  createdBy    User?              @relation("ChatThreadCreated", fields: [createdById], references: [id], onDelete: SetNull)
  team         Team?              @relation(fields: [teamId], references: [id], onDelete: SetNull)
  participants ChatParticipant[]
  messages     ChatMessage[]
  invites      ChatThreadInvite[]
  topics       ChatThreadTopic[]

  @@unique([dmKey])
  @@index([type])
  @@index([lastMessageAt])
  @@index([teamId])
}

model ChatThreadTopic {
  id        Int      @id @default(autoincrement())
  threadId  Int
  slug      String
  label     String
  order     Int      @default(0)
  createdAt DateTime @default(now())

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@unique([threadId, slug])
  @@index([threadId])
  @@index([threadId, order])
}

model ChatParticipant {
  id         Int       @id @default(autoincrement())
  threadId   Int
  userId     Int
  role       String    @default("member")
  joinedAt   DateTime  @default(now())
  leftAt     DateTime?
  lastReadAt DateTime?
  mutedUntil DateTime?

  thread ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([threadId, userId])
  @@index([userId])
  @@index([threadId])
  @@index([userId, lastReadAt])
}

model ChatMessage {
  id        Int             @id @default(autoincrement())
  threadId  Int
  senderId  Int?
  type      ChatMessageType
  content   String
  metadata  Json?
  createdAt DateTime        @default(now())

  thread ChatThread        @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User?             @relation(fields: [senderId], references: [id], onDelete: SetNull)
  links  ChatMessageLink[]

  @@index([threadId, createdAt])
  @@index([senderId])
}

model ChatMessageLink {
  id         Int      @id @default(autoincrement())
  messageId  Int
  entityType String
  entityId   String
  meta       Json?
  createdAt  DateTime @default(now())

  message ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)

  @@index([messageId])
  @@index([entityType, entityId])
}

model ChatThreadInvite {
  id            Int              @id @default(autoincrement())
  threadId      Int
  invitedUserId Int
  invitedById   Int
  status        ChatInviteStatus @default(pending)
  createdAt     DateTime         @default(now())
  respondedAt   DateTime?

  thread      ChatThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  invitedUser User       @relation("ChatThreadInviteReceived", fields: [invitedUserId], references: [id], onDelete: Cascade)
  invitedBy   User       @relation("ChatThreadInviteSent", fields: [invitedById], references: [id], onDelete: Cascade)

  @@unique([threadId, invitedUserId])
  @@index([threadId])
  @@index([invitedUserId])
  @@index([invitedById])
  @@index([status])
}

/// Ustawienia użytkownika (1:1 z User): język, motyw, powiadomienia e-mail itd.
model UserSettings {
  id                 Int      @id @default(autoincrement())
  userId             Int      @unique
  locale             String?  @default("pl") // pl | en
  timezone           String?  @default("Europe/Warsaw")
  appearanceTheme    String?  @default("system") // system | light | dark
  emailNotifications Boolean  @default(true)
  marketingEmails    Boolean  @default(false)
  llmApiKey          String? // legacy: pojedynczy klucz (fallback dla openai)
  llmProviders       Json? // [{ provider: string, apiKey: string }] — nigdy nie zwracamy apiKey do klienta
  llmSystemPrompt    String? // własny prompt systemowy dla asystenta AI (np. ton, kontekst bloga)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// Sesje użytkownika (do zakładki Activity: Current Session, Other sessions, logout others).
model UserSession {
  id             Int      @id @default(autoincrement())
  userId         Int
  sessionToken   String   @unique // identyfikator sesji (w cookie app_session_id)
  ipAddress      String?
  userAgent      String?
  location       String?
  deviceType     String? // np. Mobile, Desktop
  lastActivityAt DateTime @default(now())
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([userId, lastActivityAt])
}

/// Ostatnie logowania (do zakładki Activity: Ostatnie logowania).
model LoginEvent {
  id        Int      @id @default(autoincrement())
  userId    Int
  ipAddress String?
  location  String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

/// Logi aktywności (do zakładki Activity: Ostatnie akcje).
model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  action      String // login | logout | password_change | profile_update | ...
  description String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
}

model Notification {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String // info | success | warning | error
  title     String
  message   String
  read      Boolean  @default(false)
  actionUrl String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
}

model FriendRequest {
  id             Int                  @id @default(autoincrement())
  senderId       Int
  receiverId     Int
  status         FriendRequestStatus  @default(pending)
  previousStatus FriendRequestStatus?
  message        String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  sender   User @relation("FriendRequestSent", fields: [senderId], references: [id], onDelete: Cascade)
  receiver User @relation("FriendRequestReceived", fields: [receiverId], references: [id], onDelete: Cascade)

  @@unique([senderId, receiverId])
  @@index([receiverId, status])
  @@index([senderId, status])
}

model Team {
  id        Int      @id @default(autoincrement())
  name      String
  slug      String?
  ownerId   Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner       User         @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  members     TeamMember[]
  invites     TeamInvite[]
  chatThreads ChatThread[]

  @@unique([slug])
  @@index([ownerId])
}

model TeamMember {
  id       Int      @id @default(autoincrement())
  teamId   Int
  userId   Int
  role     TeamRole @default(member)
  joinedAt DateTime @default(now())

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([userId])
  @@index([teamId])
}

model TeamInvite {
  id             Int                  @id @default(autoincrement())
  teamId         Int
  inviterId      Int
  inviteeId      Int
  previousStatus FriendRequestStatus?
  status         TeamInviteStatus     @default(pending)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  respondedAt    DateTime?

  team    Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  inviter User @relation("TeamInviteSent", fields: [inviterId], references: [id], onDelete: Cascade)
  invitee User @relation("TeamInviteReceived", fields: [inviteeId], references: [id], onDelete: Cascade)

  @@unique([teamId, inviteeId, status])
  @@index([teamId])
  @@index([inviteeId])
  @@index([inviterId])
  @@index([status])
}

model Role {
  id          Int     @id @default(autoincrement())
  name        String  @unique
  description String?

  users       User[]           @relation("UserRole")
  permissions RolePermission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Permission {
  id    Int     @id @default(autoincrement())
  key   String  @unique
  label String?
  group String?

  roles RolePermission[]

  createdAt DateTime @default(now())
}

model RolePermission {
  roleId       Int
  permissionId Int

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
}

model ContactMessage {
  id             Int      @id @default(autoincrement())
  name           String
  email          String
  message        String
  createdAt      DateTime @default(now())
  emailSent      Boolean  @default(false)
  emailErrorCode String?
}

model EmailVerificationToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
}

model PasswordResetToken {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
  requestIp String?
  userAgent String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model OAuthAccount {
  id                Int       @id @default(autoincrement())
  userId            Int
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         DateTime?
  createdAt         DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model MediaAsset {
  id              String    @id @default(cuid())
  ownerId         Int
  type            String // 'image' | 'video' | 'file'
  status          String    @default("ready") // 'processing' | 'ready' | 'failed'
  originalName    String
  mimeType        String
  sizeBytes       Int
  width           Int?
  height          Int?
  durationSeconds Int? // video
  checksum        String?
  storageProvider String    @default("local") // 'local' | 's3'
  storagePath     String // relative path in storage
  alt             String?
  caption         String?
  tags            String[]
  deletedAt       DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  owner User @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@index([ownerId, createdAt])
  @@index([ownerId, type])
  @@index([deletedAt])
}

/// Tag blogowy (słownik tagów do wyboru przy tworzeniu/edycji posta).
model BlogTag {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  createdAt DateTime @default(now())

  @@index([name])
}

/// Post blogowy (Prisma) — tytuł, slug, treść MD, autor, tagi, SEO, data publikacji.
model BlogPost {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  title       String
  description String?
  bodyMd      String // treść w Markdown
  imageUrl    String?
  publishedAt DateTime? // null = szkic
  authorId    Int
  tags        String[]
  seoTitle    String?
  seoDesc     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  author  User         @relation(fields: [authorId], references: [id], onDelete: Cascade)
  anchors BlogAnchor[]

  @@index([authorId])
  @@index([slug])
  @@index([publishedAt])
}

/// Kotwica posta (link w aside: e.g. "Spis treści" → #toc, zewnętrzny link itd.).
model BlogAnchor {
  id         Int      @id @default(autoincrement())
  blogPostId Int
  label      String
  to         String // href: "#section" lub pełna ścieżka
  order      Int      @default(0)
  icon       String?
  target     String? // np. "_blank"
  createdAt  DateTime @default(now())

  blogPost BlogPost @relation(fields: [blogPostId], references: [id], onDelete: Cascade)

  @@index([blogPostId])
}
